<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Florida Alimony Calculator</title>
    <link rel="icon" type="image/x-icon" href="ALIMONY.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #f4f6fb;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #eef1f7;
            --border-color: #d7dbe6;
            --text-primary: #111427;
            --text-secondary: #3f435c;
            --text-muted: #6e738c;
            --accent-green: #00b894;
            --accent-blue: #2d7dff;
            --gradient-start: #00b894;
            --gradient-end: #2d7dff;
            --focus-ring: rgba(45, 125, 255, 0.18);
            --shadow-soft: 0 20px 45px rgba(16, 24, 40, 0.08);
        }

        body {
            font-family: 'DM Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle at 100% -10%, rgba(45, 125, 255, 0.16) 0%, rgba(45, 125, 255, 0) 40%),
                        radial-gradient(circle at -10% 100%, rgba(0, 184, 148, 0.12) 0%, rgba(0, 184, 148, 0) 35%),
                        var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: linear-gradient(to right, rgba(17, 20, 39, 0.04) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(17, 20, 39, 0.04) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 30px;
            box-shadow: var(--shadow-soft);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 2.2em;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: linear-gradient(120deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: contain;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: linear-gradient(120deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border: 1px solid transparent;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 0.86em;
            font-weight: 600;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(45, 125, 255, 0.22);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .income-section {
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            background: linear-gradient(165deg, var(--bg-card) 0%, #f9fbff 100%);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        }

        .income-section:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 8px 20px rgba(45, 125, 255, 0.12);
            transform: translateY(-2px);
        }

        .income-header {
            text-align: center;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .name-gender-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .income-input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--focus-ring);
        }

        .calculator-icon {
            background: linear-gradient(120deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calculator-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(45, 125, 255, 0.25);
        }

        .requirements-bar {
            width: 100%;
            margin-bottom: 30px;
            border: 1px solid #f2cf7a;
            border-left: 6px solid #d99b13;
            border-radius: 12px;
            padding: 14px 16px;
            text-align: left;
            font-size: 0.96em;
            font-weight: 700;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            background: #fff6de;
            color: #775200;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .requirements-bar:hover {
            border-color: #d99b13;
            box-shadow: 0 8px 20px rgba(195, 139, 28, 0.2);
        }

        .requirements-bar.ready {
            border-color: #93ddb5;
            border-left-color: #1f9d57;
            background: #ecfbf3;
            color: #17653d;
        }

        .requirements-list {
            margin: 8px 0 0 18px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .requirements-summary {
            color: var(--text-secondary);
        }

        .results {
            background: linear-gradient(165deg, var(--bg-card) 0%, #f7fbff 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }

        .results.show {
            display: block;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-blue);
        }

        .result-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .result-value {
            font-weight: 700;
            color: var(--accent-blue);
            font-size: 1.1em;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }

        .marriage-type {
            background: linear-gradient(120deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }

        .npv-section {
            border-top: 1px solid var(--border-color);
            margin-top: 25px;
            padding-top: 25px;
        }

        .npv-header {
            text-align: center;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .npv-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .warning {
            background: #fff8dc;
            border: 1px solid #f3dc8a;
            color: #735f1a;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .legal-disclaimer {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 20px;
            border-radius: 12px;
            margin-top: 25px;
            font-size: 0.85em;
            line-height: 1.5;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(10, 16, 32, 0.45);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-soft);
        }

        .modal-header {
            background: linear-gradient(120deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
            background: linear-gradient(165deg, #ffffff 0%, #f8fbff 100%);
        }

        .income-modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .income-section-modal {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .income-section-modal h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid var(--accent-blue);
            padding-bottom: 5px;
        }

        .income-line {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .line-number {
            font-weight: 600;
            color: var(--text-muted);
            width: 25px;
        }

        .line-description {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .line-input {
            width: 120px;
            padding: 5px 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: right;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }

        .total-line {
            border-top: 2px solid var(--accent-blue);
            padding-top: 10px;
            margin-top: 15px;
            font-weight: 700;
        }

        .modal-footer {
            background: #f7f9fc;
            padding: 20px;
            border-radius: 0 0 20px 20px;
            border-top: 1px solid var(--border-color);
            text-align: right;
        }

        .input-group {
            position: relative;
        }

        .input-prefix {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-weight: 600;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }

        .input-group input {
            padding-left: 35px;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }

        .attachment-section {
            margin-top: 16px;
            border-top: 1px solid var(--border-color);
            padding-top: 14px;
        }

        .attachment-section-title {
            font-size: 0.9em;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .attachment-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .attachment-toolbar {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .attachment-dropzone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            background: #f8fbff;
            padding: 14px;
            cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .attachment-dropzone:hover {
            border-color: var(--accent-blue);
            background: #eef6ff;
        }

        .attachment-dropzone:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--focus-ring);
        }

        .attachment-dropzone.is-dragover {
            border-color: var(--accent-blue);
            background: #e7f2ff;
        }

        .attachment-dropzone-title {
            font-size: 0.88em;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .attachment-dropzone-subtitle {
            font-size: 0.82em;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .attachment-empty {
            font-size: 0.85em;
            color: var(--text-muted);
            border: 1px dashed var(--border-color);
            border-radius: 10px;
            padding: 10px;
            background: #fbfcff;
        }

        .attachment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 8px 10px;
            background: #ffffff;
        }

        .attachment-name {
            font-size: 0.85em;
            color: var(--text-primary);
            word-break: break-word;
            flex: 1;
        }

        .attachment-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .attachment-btn {
            border: 1px solid var(--border-color);
            background: #f4f7ff;
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 9px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
        }

        .attachment-btn:hover {
            border-color: var(--accent-blue);
            background: #e9f1ff;
        }

        .attachment-modal-content {
            max-width: 980px;
        }

        .attachment-viewer-content {
            min-height: 58vh;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: #f6f8fd;
            padding: 12px;
            overflow: auto;
        }

        .attachment-viewer-content img,
        .attachment-viewer-content embed,
        .attachment-viewer-content iframe {
            max-width: 100%;
            width: 100%;
            border: none;
            border-radius: 8px;
        }

        .attachment-viewer-content iframe,
        .attachment-viewer-content embed {
            min-height: 70vh;
            background: #ffffff;
        }

        /* Print Styles - Single Sheet Court Exhibit */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 12px !important;
                line-height: 1.3 !important;
                color: black !important;
            }

            body::before {
                display: none !important;
            }

            .container {
                background: white !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 20px !important;
                margin: 0 !important;
                max-width: none !important;
                width: 100% !important;
            }

            .header {
                border-bottom: 2px solid black !important;
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
            }

            .header h1 {
                color: black !important;
                font-size: 18px !important;
                margin-bottom: 5px !important;
                background: none !important;
                -webkit-text-fill-color: initial !important;
            }

            .header p {
                color: black !important;
                font-size: 10px !important;
            }

            /* Hide form and action buttons in print */
            .action-buttons,
            form,
            .legal-disclaimer,
            .modal {
                display: none !important;
            }

            /* Show only results in print */
            .results {
                display: block !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }

            .print-header {
                display: block !important;
                text-align: center;
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 15px;
                padding: 10px;
                border: 2px solid black;
                background: #f0f0f0;
            }

            .print-parties {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 15px;
                padding: 10px;
                border: 1px solid black;
            }

            .party-info {
                text-align: center;
            }

            .party-info h3 {
                font-size: 12px;
                margin-bottom: 5px;
                text-decoration: underline;
            }

            .marriage-type {
                background: #e0e0e0 !important;
                color: black !important;
                border: 1px solid black !important;
                border-radius: 0 !important;
                margin-bottom: 10px !important;
                padding: 8px !important;
                font-size: 11px !important;
                text-align: center !important;
            }

            .result-item {
                display: grid !important;
                grid-template-columns: 2fr 1fr !important;
                gap: 10px !important;
                margin-bottom: 8px !important;
                padding: 6px 10px !important;
                background: white !important;
                border: 1px solid #ccc !important;
                border-radius: 0 !important;
                border-left: 3px solid black !important;
                font-size: 11px !important;
            }

            .result-label {
                font-weight: 600 !important;
                color: black !important;
            }

            .result-value {
                font-weight: 700 !important;
                color: black !important;
                text-align: right !important;
                font-size: 11px !important;
            }

            .npv-section {
                border-top: 2px solid black !important;
                margin-top: 15px !important;
                padding-top: 10px !important;
            }

            .npv-header {
                font-size: 12px !important;
                font-weight: 700 !important;
                color: black !important;
                text-align: center !important;
                margin-bottom: 10px !important;
                text-decoration: underline;
            }

            .warning {
                background: #f0f0f0 !important;
                border: 1px solid black !important;
                color: black !important;
                padding: 8px !important;
                margin-top: 10px !important;
                font-size: 10px !important;
                border-radius: 0 !important;
            }

            .print-footer {
                display: block !important;
                margin-top: 20px;
                padding-top: 10px;
                border-top: 1px solid black;
                font-size: 9px;
                text-align: center;
                color: black;
            }

            /* Ensure single page */
            * {
                page-break-inside: avoid !important;
            }

            .results {
                page-break-inside: avoid !important;
            }
        }

        /* Hide print-only elements from screen */
        .print-only {
            display: none;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-group.full-width {
                grid-column: span 1;
            }
            
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }

            .income-modal-grid {
                grid-template-columns: 1fr;
            }

            .npv-grid {
                grid-template-columns: 1fr;
            }

            .name-gender-row {
                grid-template-columns: 1fr;
            }

            .income-input-row {
                grid-template-columns: 1fr;
            }

            .attachment-item {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><img src="ALIMONY 50x50.png" alt="App Icon" class="header-icon"> Florida Alimony Calculator</h1>
            <p>Calculate maximum alimony under Florida's revised statutes (effective July 1, 2023)</p>
        </div>

        <div class="action-buttons">
            <button class="action-btn" onclick="saveData()">Save ZIP</button>
            <button class="action-btn" onclick="loadData()">Load ZIP</button>
            <button class="action-btn" onclick="printToPDF()">üñ®Ô∏è Print to PDF</button>
        </div>

        <form id="alimonyForm">
            <div class="form-grid">
                <div class="income-section">
                    <div class="income-header">Higher Earner</div>
                    <div class="name-gender-row">
                        <div class="form-group">
                            <label for="higherEarnerName">Name:</label>
                            <input type="text" id="higherEarnerName" name="higherEarnerName">
                        </div>
                        <div class="form-group">
                            <label for="higherEarnerGender">Gender:</label>
                            <select id="higherEarnerGender" name="higherEarnerGender" onchange="updateLowerEarnerGender()">
                                <option value="">Select</option>
                                <option value="Husband">Husband</option>
                                <option value="Wife">Wife</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="higherIncome">Net Monthly Income:</label>
                        <div class="income-input-row">
                            <div class="input-group">
                                <span class="input-prefix">$</span>
                                <input type="text" id="higherIncome" name="higherIncome" required 
                                       oninput="formatCurrency(this)" onblur="finalizeCurrency(this)">
                            </div>
                            <button type="button" class="calculator-icon" onclick="openIncomeModal('higher')" title="Calculate Net Income">üßÆ</button>
                        </div>
                    </div>
                    <div class="attachment-section">
                        <div class="attachment-section-title">Supporting Documents</div>
                        <div id="higherAttachmentDropzone" class="attachment-dropzone" tabindex="0" role="button" aria-label="Add higher earner attachment" onclick="triggerAttachmentUpload('higher')">
                            <div class="attachment-dropzone-title">Drag and drop files here</div>
                            <div class="attachment-dropzone-subtitle">or click to browse</div>
                        </div>
                        <div class="attachment-toolbar">
                            <button type="button" class="attachment-btn" onclick="pasteScreenshot('higher')">Paste Screenshot</button>
                        </div>
                        <input type="file" id="higherAttachmentInput" multiple style="display: none;" onchange="handleAttachmentSelection(event, 'higher')">
                        <div id="higherAttachmentsList" class="attachment-list">
                            <div class="attachment-empty">No attachments yet.</div>
                        </div>
                    </div>
                </div>

                <div class="income-section">
                    <div class="income-header">Lower Earner</div>
                    <div class="name-gender-row">
                        <div class="form-group">
                            <label for="lowerEarnerName">Name:</label>
                            <input type="text" id="lowerEarnerName" name="lowerEarnerName">
                        </div>
                        <div class="form-group">
                            <label for="lowerEarnerGender">Gender:</label>
                            <select id="lowerEarnerGender" name="lowerEarnerGender" disabled>
                                <option value="">Auto-filled</option>
                                <option value="Husband">Husband</option>
                                <option value="Wife">Wife</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="lowerIncome">Net Monthly Income:</label>
                        <div class="income-input-row">
                            <div class="input-group">
                                <span class="input-prefix">$</span>
                                <input type="text" id="lowerIncome" name="lowerIncome" required 
                                       oninput="formatCurrency(this)" onblur="finalizeCurrency(this)">
                            </div>
                            <button type="button" class="calculator-icon" onclick="openIncomeModal('lower')" title="Calculate Net Income">üßÆ</button>
                        </div>
                    </div>
                    <div class="attachment-section">
                        <div class="attachment-section-title">Supporting Documents</div>
                        <div id="lowerAttachmentDropzone" class="attachment-dropzone" tabindex="0" role="button" aria-label="Add lower earner attachment" onclick="triggerAttachmentUpload('lower')">
                            <div class="attachment-dropzone-title">Drag and drop files here</div>
                            <div class="attachment-dropzone-subtitle">or click to browse</div>
                        </div>
                        <div class="attachment-toolbar">
                            <button type="button" class="attachment-btn" onclick="pasteScreenshot('lower')">Paste Screenshot</button>
                        </div>
                        <input type="file" id="lowerAttachmentInput" multiple style="display: none;" onchange="handleAttachmentSelection(event, 'lower')">
                        <div id="lowerAttachmentsList" class="attachment-list">
                            <div class="attachment-empty">No attachments yet.</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="marriageDate">Date of Marriage:</label>
                    <input type="date" id="marriageDate" name="marriageDate" required>
                </div>

                <div class="form-group">
                    <label for="filingDate">Date of Filing/Petition:</label>
                    <input type="date" id="filingDate" name="filingDate" required>
                </div>

                <div class="form-group full-width">
                    <label for="reasonableNeed">Reasonable Monthly Need of Receiving Spouse:</label>
                    <div class="input-group">
                        <span class="input-prefix">$</span>
                        <input type="text" id="reasonableNeed" name="reasonableNeed" required 
                               oninput="formatCurrency(this)" onblur="finalizeCurrency(this)">
                    </div>
                </div>
            </div>

            <button type="button" id="requirementsBar" class="requirements-bar" onclick="handleRequirementsBarClick()">Additional terms required</button>
        </form>

        <div id="results" class="results">
            <div id="marriageType" class="marriage-type"></div>
            
            <div class="result-item">
                <span class="result-label">Years of Marriage:</span>
                <span class="result-value" id="yearsMarried"></span>
            </div>

            <div class="result-item">
                <span class="result-label">Income Difference (Monthly):</span>
                <span class="result-value" id="incomeDifference"></span>
            </div>

            <div class="result-item">
                <span class="result-label">35% of Income Difference:</span>
                <span class="result-value" id="thirtyFivePercent"></span>
            </div>

            <div class="result-item">
                <span class="result-label">Maximum Monthly Alimony Amount:</span>
                <span class="result-value" id="maxAlimonyAmount"></span>
            </div>

            <div class="result-item">
                <span class="result-label">Maximum Duration of Alimony:</span>
                <span class="result-value" id="maxDuration"></span>
            </div>

            <div class="result-item">
                <span class="result-label">Total Maximum Alimony Payment:</span>
                <span class="result-value" id="totalPayment"></span>
            </div>

            <div id="warningMessage" class="warning" style="display: none;"></div>
        </div>

        <div id="npvSection" class="npv-section hidden">
            <div class="npv-header">Net Present Value (NPV) Calculator</div>
            <div class="npv-grid">
                <div class="form-group">
                    <label for="npvAmount">Monthly Payment Amount:</label>
                    <div class="input-group">
                        <span class="input-prefix">$</span>
                        <input type="text" id="npvAmount" name="npvAmount" 
                               oninput="formatCurrency(this)" onblur="finalizeCurrency(this); calculateNPV()">
                    </div>
                </div>
                <div class="form-group">
                    <label for="npvYears">Number of Years:</label>
                    <input type="number" id="npvYears" name="npvYears" step="0.1" 
                           onchange="calculateNPV()">
                </div>
                <div class="form-group">
                    <label for="discountRate">Discount Rate (%):</label>
                    <input type="number" id="discountRate" name="discountRate" step="0.1" value="5.0" 
                           onchange="calculateNPV()">
                </div>
            </div>
            <div class="result-item">
                <span class="result-label">Total Paid Over Term:</span>
                <span class="result-value" id="totalPaidOverTerm">$0.00</span>
            </div>
            <div class="result-item">
                <span class="result-label">Net Present Value (Lump Sum):</span>
                <span class="result-value" id="npvResult">$0.00</span>
            </div>
        </div>

        <div class="legal-disclaimer">
            <strong>Legal Disclaimer:</strong> This calculator provides estimates based on Florida's 2023 alimony reform statutes. Actual alimony awards may vary based on individual circumstances, statutory factors under F.S. 61.08, and judicial discretion. Courts may deviate from these guidelines based on exceptional circumstances. This tool is for informational purposes only and does not constitute legal advice. Please consult with a qualified Florida family law attorney for personalized legal guidance regarding your specific situation.
        </div>
    </div>

    <!-- Income Calculator Modal -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Net Income Calculator</h2>
                <span class="close" onclick="closeIncomeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="income-modal-grid">
                    <div class="income-section-modal">
                        <h3>PRESENT MONTHLY GROSS INCOME</h3>
                        <div class="income-line">
                            <span class="line-number">1.</span>
                            <span class="line-description">Gross salary or wages</span>
                            <input type="text" class="line-input" id="income1" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">2.</span>
                            <span class="line-description">Bonuses, commissions, allowances, overtime, tips</span>
                            <input type="text" class="line-input" id="income2" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">3.</span>
                            <span class="line-description">Business income from self-employment, partnerships, etc.</span>
                            <input type="text" class="line-input" id="income3" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">4.</span>
                            <span class="line-description">Disability benefits/SSI</span>
                            <input type="text" class="line-input" id="income4" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">5.</span>
                            <span class="line-description">Workers' compensation</span>
                            <input type="text" class="line-input" id="income5" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">6.</span>
                            <span class="line-description">Unemployment assistance</span>
                            <input type="text" class="line-input" id="income6" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">7.</span>
                            <span class="line-description">Pension, retirement, or annuity payments</span>
                            <input type="text" class="line-input" id="income7" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">8.</span>
                            <span class="line-description">Social Security benefits</span>
                            <input type="text" class="line-input" id="income8" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">9.</span>
                            <span class="line-description">Alimony actually received</span>
                            <input type="text" class="line-input" id="income9" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">10.</span>
                            <span class="line-description">Interest and dividends</span>
                            <input type="text" class="line-input" id="income10" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">11.</span>
                            <span class="line-description">Rental income (gross receipts minus expenses)</span>
                            <input type="text" class="line-input" id="income11" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">12.</span>
                            <span class="line-description">Income from royalties, trusts, or estates</span>
                            <input type="text" class="line-input" id="income12" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">13.</span>
                            <span class="line-description">Reimbursed expenses and in-kind payments</span>
                            <input type="text" class="line-input" id="income13" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">14.</span>
                            <span class="line-description">Gains from dealing in property</span>
                            <input type="text" class="line-input" id="income14" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">15.</span>
                            <span class="line-description">Any other income of a recurring nature</span>
                            <input type="text" class="line-input" id="income15" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line total-line">
                            <span class="line-number">17.</span>
                            <span class="line-description"><strong>TOTAL PRESENT MONTHLY GROSS INCOME</strong></span>
                            <input type="text" class="line-input" id="totalGrossIncome" readonly style="font-weight: bold; background: #f0f0f0;">
                        </div>
                    </div>

                    <div class="income-section-modal">
                        <h3>PRESENT MONTHLY DEDUCTIONS</h3>
                        <div class="income-line">
                            <span class="line-number">18.</span>
                            <span class="line-description">Federal, state, and local income tax</span>
                            <input type="text" class="line-input" id="deduction18" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">19.</span>
                            <span class="line-description">FICA or self-employment taxes</span>
                            <input type="text" class="line-input" id="deduction19" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">20.</span>
                            <span class="line-description">Medicare payments</span>
                            <input type="text" class="line-input" id="deduction20" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">21.</span>
                            <span class="line-description">Mandatory union dues</span>
                            <input type="text" class="line-input" id="deduction21" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">22.</span>
                            <span class="line-description">Mandatory retirement payments</span>
                            <input type="text" class="line-input" id="deduction22" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">23.</span>
                            <span class="line-description">Health insurance payments</span>
                            <input type="text" class="line-input" id="deduction23" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">24.</span>
                            <span class="line-description">Court-ordered child support actually paid</span>
                            <input type="text" class="line-input" id="deduction24" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line">
                            <span class="line-number">25.</span>
                            <span class="line-description">Court-ordered alimony actually paid</span>
                            <input type="text" class="line-input" id="deduction25" oninput="formatModalCurrency(this)" onblur="finalizeModalCurrency(this); calculateModalNet()">
                        </div>
                        <div class="income-line total-line">
                            <span class="line-number">26.</span>
                            <span class="line-description"><strong>TOTAL DEDUCTIONS</strong></span>
                            <input type="text" class="line-input" id="totalDeductions" readonly style="font-weight: bold; background: #f0f0f0;">
                        </div>
                        <div class="income-line total-line" style="border-top: 3px solid #667eea; margin-top: 20px; padding-top: 15px;">
                            <span class="line-number"></span>
                            <span class="line-description"><strong>NET MONTHLY INCOME</strong></span>
                            <input type="text" class="line-input" id="modalNetIncome" readonly style="font-weight: bold; background: #667eea; color: white;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" onclick="applyModalIncome()">Apply to Main Calculator</button>
                <button class="action-btn" onclick="closeIncomeModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="attachmentModal" class="modal">
        <div class="modal-content attachment-modal-content">
            <div class="modal-header">
                <h2 id="attachmentModalTitle">Attachment Viewer</h2>
                <span class="close" onclick="closeAttachmentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="attachmentViewerContent" class="attachment-viewer-content"></div>
            </div>
        </div>
    </div>

    <div id="requirementsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Additional Terms Required</h2>
                <span class="close" onclick="closeRequirementsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="requirementsSummary" class="requirements-summary"></p>
                <ul id="requirementsList" class="requirements-list"></ul>
            </div>
            <div class="modal-footer">
                <button class="action-btn" type="button" onclick="closeRequirementsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for loading data -->
    <input type="file" id="fileInput" accept=".json,.zip" style="display: none;" onchange="handleFileLoad(event)">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        let currentModalTarget = '';
        let pendingPastePersonKey = null;
        const MAIN_CURRENCY_INPUT_IDS = ['higherIncome', 'lowerIncome', 'reasonableNeed', 'npvAmount'];
        const PERSON_KEYS = ['higher', 'lower'];
        const ZIP_DATA_FILENAME = 'mediation_data.json';
        const ATTACHMENTS_FOLDER = 'attachments/';
        const personAttachments = {
            higher: [],
            lower: []
        };
        const REQUIRED_FIELDS = [
            { id: 'higherIncome', label: 'Higher Earner Net Monthly Income' },
            { id: 'lowerIncome', label: 'Lower Earner Net Monthly Income' },
            { id: 'marriageDate', label: 'Date of Marriage' },
            { id: 'filingDate', label: 'Date of Filing/Petition' },
            { id: 'reasonableNeed', label: 'Reasonable Monthly Need of Receiving Spouse' }
        ];
        const requiredFieldTouched = {};

        // Currency formatting functions
        function sanitizeCurrencyInput(rawValue) {
            const cleaned = String(rawValue || '').replace(/[^\d.]/g, '');
            if (!cleaned) {
                return '';
            }

            const parts = cleaned.split('.');
            const integerDigits = (parts[0] || '').replace(/^0+(?=\d)/, '');
            const integerPart = integerDigits || '0';

            if (parts.length === 1) {
                return integerPart;
            }

            const decimalPart = parts.slice(1).join('').slice(0, 2);
            if (cleaned.endsWith('.') && decimalPart.length === 0) {
                return integerPart + '.';
            }

            return integerPart + '.' + decimalPart;
        }

        function formatCurrencyForTyping(rawValue) {
            const sanitized = sanitizeCurrencyInput(rawValue);
            if (!sanitized) {
                return '';
            }

            const hasDecimal = sanitized.includes('.');
            const isTrailingDecimal = sanitized.endsWith('.');
            const [integerPart, decimalPart = ''] = sanitized.split('.');
            const formattedInteger = Number(integerPart).toLocaleString('en-US');

            if (!hasDecimal) {
                return formattedInteger;
            }

            if (isTrailingDecimal) {
                return formattedInteger + '.';
            }

            return formattedInteger + '.' + decimalPart;
        }

        function formatCurrency(input) {
            input.value = formatCurrencyForTyping(input.value);
        }

        function finalizeCurrency(input) {
            if (!/[\d]/.test(String(input.value))) {
                input.value = '';
                return;
            }

            const numericValue = parseCurrency(input.value);
            input.value = fmtInputMoney(numericValue);
        }

        function prepareCurrencyEdit(input) {
            if (!/[\d]/.test(String(input.value))) {
                input.value = '';
                return;
            }

            const numericValue = parseCurrency(input.value);
            input.value = numericValue
                .toFixed(2)
                .replace(/\.00$/, '')
                .replace(/(\.\d)0$/, '$1');
        }

        function initializeMainCurrencyInputs() {
            MAIN_CURRENCY_INPUT_IDS.forEach((id) => {
                const input = document.getElementById(id);
                if (!input) {
                    return;
                }

                input.setAttribute('inputmode', 'decimal');
                input.addEventListener('focus', function() {
                    prepareCurrencyEdit(this);
                });
            });
        }

        function normalizeMainCurrencyInputValues() {
            MAIN_CURRENCY_INPUT_IDS.forEach((id) => {
                const input = document.getElementById(id);
                if (!input) {
                    return;
                }

                if (!/[\d]/.test(String(input.value))) {
                    input.value = '';
                    return;
                }

                input.value = fmtInputMoney(parseCurrency(input.value));
            });
        }

        function formatModalCurrency(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (value) {
                value = parseInt(value).toLocaleString();
                input.value = value;
            }
        }

        function finalizeModalCurrency(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (value) {
                let numValue = parseInt(value);
                input.value = numValue.toLocaleString('en-US');
            }
        }

        function parseCurrency(value) {
            return parseFloat(String(value).replace(/[$,]/g, '')) || 0;
        }

        function fmtInputMoney(x) {
            return Number(x).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // --- Currency formatting helper for two decimals everywhere ---
        function fmtMoney(x) {
            return '$' + fmtInputMoney(x);
        }

        // Gender selection logic
        function updateLowerEarnerGender() {
            const higherGender = document.getElementById('higherEarnerGender').value;
            const lowerGenderSelect = document.getElementById('lowerEarnerGender');
            
            if (higherGender === 'Husband') {
                lowerGenderSelect.value = 'Wife';
            } else if (higherGender === 'Wife') {
                lowerGenderSelect.value = 'Husband';
            } else {
                lowerGenderSelect.value = '';
            }
        }

        function createAttachmentId() {
            return 'att_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
        }

        function sanitizeFileKeyPart(value) {
            return String(value || 'file')
                .replace(/[<>:"/\\|?*\x00-\x1F]/g, '_')
                .replace(/\s+/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_+|_+$/g, '')
                .slice(0, 80);
        }

        function getFileExtension(fileName) {
            const parts = String(fileName || '').split('.');
            if (parts.length < 2) {
                return '';
            }
            return parts.pop().toLowerCase();
        }

        function getExtensionForAttachment(attachment) {
            const fromName = getFileExtension(attachment.name);
            if (fromName) {
                return fromName;
            }

            const mimeMap = {
                'application/pdf': 'pdf',
                'image/jpeg': 'jpg',
                'image/png': 'png',
                'image/webp': 'webp',
                'image/gif': 'gif'
            };

            return mimeMap[attachment.type] || 'bin';
        }

        function guessMimeTypeFromName(fileName) {
            const extension = getFileExtension(fileName);
            const extensionMap = {
                pdf: 'application/pdf',
                jpg: 'image/jpeg',
                jpeg: 'image/jpeg',
                png: 'image/png',
                webp: 'image/webp',
                gif: 'image/gif'
            };

            return extensionMap[extension] || 'application/octet-stream';
        }

        function splitDataUrl(dataUrl) {
            const marker = ';base64,';
            const markerIndex = String(dataUrl || '').indexOf(marker);
            if (markerIndex === -1) {
                return null;
            }

            const mimeType = dataUrl.slice(5, markerIndex) || 'application/octet-stream';
            const base64 = dataUrl.slice(markerIndex + marker.length);
            if (!base64) {
                return null;
            }

            return { mimeType, base64 };
        }

        function buildDataUrl(mimeType, base64Data) {
            return `data:${mimeType || 'application/octet-stream'};base64,${base64Data}`;
        }

        function triggerAttachmentUpload(personKey) {
            const fileInput = document.getElementById(`${personKey}AttachmentInput`);
            if (fileInput) {
                fileInput.click();
            }
        }

        function getExtensionForMimeType(mimeType) {
            const mimeMap = {
                'application/pdf': 'pdf',
                'image/jpeg': 'jpg',
                'image/png': 'png',
                'image/webp': 'webp',
                'image/gif': 'gif',
                'image/bmp': 'bmp'
            };

            return mimeMap[mimeType] || 'png';
        }

        function buildScreenshotFileName(mimeType) {
            const extension = getExtensionForMimeType(mimeType);
            const stamp = new Date().toISOString().replace('T', '_').replace(/[:.]/g, '-').slice(0, 19);
            return `Screenshot_${stamp}.${extension}`;
        }

        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function() {
                    reject(new Error(`Unable to read file: ${file.name}`));
                };
                reader.readAsDataURL(file);
            });
        }

        async function addAttachmentsFromFiles(personKey, files) {
            const normalizedFiles = Array.from(files || []).filter(Boolean);
            if (!normalizedFiles.length) {
                return;
            }

            if (!PERSON_KEYS.includes(personKey)) {
                throw new Error('Invalid attachment target.');
            }

            const dataUrls = await Promise.all(normalizedFiles.map((file) => readFileAsDataUrl(file)));
            dataUrls.forEach((dataUrl, index) => {
                const file = normalizedFiles[index];
                personAttachments[personKey].push({
                    id: createAttachmentId(),
                    name: file.name || `Attachment_${Date.now()}_${index + 1}`,
                    type: file.type || guessMimeTypeFromName(file.name),
                    data: dataUrl
                });
            });

            renderAttachmentList(personKey);
        }

        async function handleAttachmentSelection(event, personKey) {
            const files = Array.from(event.target.files || []);
            if (!files.length) {
                return;
            }

            try {
                await addAttachmentsFromFiles(personKey, files);
            } catch (error) {
                alert(error.message);
            } finally {
                event.target.value = '';
            }
        }

        async function pasteScreenshot(personKey) {
            if (!PERSON_KEYS.includes(personKey)) {
                return;
            }

            if (window.isSecureContext && navigator.clipboard && typeof navigator.clipboard.read === 'function') {
                try {
                    const clipboardItems = await navigator.clipboard.read();
                    for (const item of clipboardItems) {
                        const imageType = item.types.find((type) => type.startsWith('image/'));
                        if (!imageType) {
                            continue;
                        }

                        const blob = await item.getType(imageType);
                        const file = new File([blob], buildScreenshotFileName(imageType), { type: imageType });
                        await addAttachmentsFromFiles(personKey, [file]);
                        pendingPastePersonKey = null;
                        return;
                    }

                    alert('No screenshot image was found on your clipboard.');
                    return;
                } catch (error) {
                    // Fallback to Ctrl+V listener below.
                }
            }

            pendingPastePersonKey = personKey;
            alert('Press Ctrl+V (or Command+V on Mac) now to paste a screenshot.');
        }

        function setupAttachmentDropZones() {
            PERSON_KEYS.forEach((personKey) => {
                const dropzone = document.getElementById(`${personKey}AttachmentDropzone`);
                if (!dropzone) {
                    return;
                }

                const preventDefaults = (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                };

                ['dragenter', 'dragover'].forEach((eventName) => {
                    dropzone.addEventListener(eventName, (event) => {
                        preventDefaults(event);
                        dropzone.classList.add('is-dragover');
                    });
                });

                ['dragleave', 'dragend', 'drop'].forEach((eventName) => {
                    dropzone.addEventListener(eventName, (event) => {
                        preventDefaults(event);
                        dropzone.classList.remove('is-dragover');
                    });
                });

                dropzone.addEventListener('drop', async (event) => {
                    const files = Array.from((event.dataTransfer && event.dataTransfer.files) || []);
                    if (!files.length) {
                        return;
                    }

                    try {
                        await addAttachmentsFromFiles(personKey, files);
                    } catch (error) {
                        alert(error.message);
                    }
                });

                dropzone.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        triggerAttachmentUpload(personKey);
                    }
                });
            });
        }

        window.addEventListener('paste', async function(event) {
            if (!pendingPastePersonKey) {
                return;
            }

            const clipboardItems = Array.from((event.clipboardData && event.clipboardData.items) || []);
            const imageFiles = clipboardItems
                .filter((item) => item.kind === 'file' && item.type.startsWith('image/'))
                .map((item) => item.getAsFile())
                .filter(Boolean);

            const personKey = pendingPastePersonKey;
            pendingPastePersonKey = null;

            if (!imageFiles.length) {
                alert('No screenshot image was found in pasted clipboard data.');
                return;
            }

            event.preventDefault();

            try {
                const normalizedFiles = imageFiles.map((file) => {
                    if (file.name) {
                        return file;
                    }
                    return new File([file], buildScreenshotFileName(file.type), { type: file.type || 'image/png' });
                });
                await addAttachmentsFromFiles(personKey, normalizedFiles);
            } catch (error) {
                alert(error.message);
            }
        });

        function removeAttachment(personKey, attachmentId) {
            personAttachments[personKey] = personAttachments[personKey].filter((attachment) => attachment.id !== attachmentId);
            renderAttachmentList(personKey);
        }

        function viewAttachment(personKey, attachmentId) {
            const attachment = personAttachments[personKey].find((item) => item.id === attachmentId);
            if (!attachment) {
                return;
            }

            const modal = document.getElementById('attachmentModal');
            const modalTitle = document.getElementById('attachmentModalTitle');
            const viewer = document.getElementById('attachmentViewerContent');

            modalTitle.textContent = attachment.name || 'Attachment Viewer';
            viewer.innerHTML = '';

            if (String(attachment.type).startsWith('image/')) {
                const img = document.createElement('img');
                img.src = attachment.data;
                img.alt = attachment.name || 'Attachment image';
                viewer.appendChild(img);
            } else if (attachment.type === 'application/pdf') {
                const iframe = document.createElement('iframe');
                iframe.src = attachment.data;
                iframe.title = attachment.name || 'Attachment PDF';
                viewer.appendChild(iframe);
            } else {
                const info = document.createElement('p');
                info.textContent = 'Preview is not available for this file type. Use Open/Download.';
                info.style.marginBottom = '10px';

                const link = document.createElement('a');
                link.href = attachment.data;
                link.download = attachment.name || 'attachment';
                link.textContent = 'Open/Download Attachment';
                link.className = 'attachment-btn';

                viewer.appendChild(info);
                viewer.appendChild(link);
            }

            modal.style.display = 'block';
        }

        function closeAttachmentModal() {
            document.getElementById('attachmentModal').style.display = 'none';
            document.getElementById('attachmentViewerContent').innerHTML = '';
        }

        function renderAttachmentList(personKey) {
            const listEl = document.getElementById(`${personKey}AttachmentsList`);
            if (!listEl) {
                return;
            }

            listEl.innerHTML = '';
            const attachments = personAttachments[personKey] || [];

            if (!attachments.length) {
                const emptyEl = document.createElement('div');
                emptyEl.className = 'attachment-empty';
                emptyEl.textContent = 'No attachments yet.';
                listEl.appendChild(emptyEl);
                return;
            }

            attachments.forEach((attachment) => {
                const rowEl = document.createElement('div');
                rowEl.className = 'attachment-item';

                const nameEl = document.createElement('div');
                nameEl.className = 'attachment-name';
                nameEl.textContent = attachment.name || 'Untitled attachment';

                const actionsEl = document.createElement('div');
                actionsEl.className = 'attachment-actions';

                const viewBtn = document.createElement('button');
                viewBtn.type = 'button';
                viewBtn.className = 'attachment-btn';
                viewBtn.textContent = 'View';
                viewBtn.addEventListener('click', function() {
                    viewAttachment(personKey, attachment.id);
                });

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'attachment-btn';
                removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', function() {
                    removeAttachment(personKey, attachment.id);
                });

                actionsEl.appendChild(viewBtn);
                actionsEl.appendChild(removeBtn);
                rowEl.appendChild(nameEl);
                rowEl.appendChild(actionsEl);
                listEl.appendChild(rowEl);
            });
        }

        function renderAllAttachmentLists() {
            PERSON_KEYS.forEach((personKey) => renderAttachmentList(personKey));
        }

        function clearAllAttachments() {
            PERSON_KEYS.forEach((personKey) => {
                personAttachments[personKey] = [];
            });
            renderAllAttachmentLists();
        }

        function getFormState() {
            return {
                higherEarnerName: document.getElementById('higherEarnerName').value,
                higherEarnerGender: document.getElementById('higherEarnerGender').value,
                higherIncome: document.getElementById('higherIncome').value,
                lowerEarnerName: document.getElementById('lowerEarnerName').value,
                lowerEarnerGender: document.getElementById('lowerEarnerGender').value,
                lowerIncome: document.getElementById('lowerIncome').value,
                marriageDate: document.getElementById('marriageDate').value,
                filingDate: document.getElementById('filingDate').value,
                reasonableNeed: document.getElementById('reasonableNeed').value,
                npvAmount: document.getElementById('npvAmount').value,
                npvYears: document.getElementById('npvYears').value,
                discountRate: document.getElementById('discountRate').value
            };
        }

        function applyFormState(data) {
            Object.keys(data || {}).forEach((key) => {
                if (key === 'attachments') {
                    return;
                }

                const element = document.getElementById(key);
                if (element) {
                    element.value = data[key] || '';
                }
            });

            normalizeMainCurrencyInputValues();
            updateLowerEarnerGender();
        }

        function exportStateWithAttachments() {
            const state = getFormState();
            const exportState = JSON.parse(JSON.stringify(state));
            exportState.attachments = { higher: [], lower: [] };

            const exportedAttachments = [];
            const usedFileKeys = new Set();

            PERSON_KEYS.forEach((personKey) => {
                const sourceAttachments = personAttachments[personKey] || [];
                sourceAttachments.forEach((attachment, index) => {
                    const split = splitDataUrl(attachment.data);
                    if (!split) {
                        return;
                    }

                    const baseName = sanitizeFileKeyPart((attachment.name || `${personKey}_attachment_${index + 1}`).replace(/\.[^/.]+$/, '')) || `${personKey}_attachment_${index + 1}`;
                    const extension = getExtensionForAttachment(attachment);
                    let fileKey = `${personKey}_${baseName}.${extension}`;
                    let counter = 1;

                    while (usedFileKeys.has(fileKey)) {
                        counter += 1;
                        fileKey = `${personKey}_${baseName}_${counter}.${extension}`;
                    }

                    usedFileKeys.add(fileKey);
                    exportState.attachments[personKey].push({
                        name: attachment.name,
                        type: attachment.type || split.mimeType,
                        fileKey: fileKey
                    });

                    exportedAttachments.push({
                        fileKey: fileKey,
                        base64: split.base64
                    });
                });
            });

            return {
                state: exportState,
                attachments: exportedAttachments
            };
        }

        function importStateWithAttachments(state, attachmentLookup) {
            applyFormState(state || {});

            PERSON_KEYS.forEach((personKey) => {
                const loaded = [];
                const metadataList = state && state.attachments && Array.isArray(state.attachments[personKey])
                    ? state.attachments[personKey]
                    : [];

                metadataList.forEach((metadata) => {
                    const base64 = attachmentLookup[metadata.fileKey];
                    if (!base64) {
                        return;
                    }

                    const mimeType = metadata.type || guessMimeTypeFromName(metadata.name || metadata.fileKey);
                    loaded.push({
                        id: createAttachmentId(),
                        name: metadata.name || metadata.fileKey,
                        type: mimeType,
                        data: buildDataUrl(mimeType, base64)
                    });
                });

                personAttachments[personKey] = loaded;
            });

            renderAllAttachmentLists();
        }

        function importInlineAttachments(attachmentsData) {
            PERSON_KEYS.forEach((personKey) => {
                const sourceList = attachmentsData && Array.isArray(attachmentsData[personKey]) ? attachmentsData[personKey] : [];
                personAttachments[personKey] = sourceList
                    .filter((entry) => entry && entry.data)
                    .map((entry) => ({
                        id: createAttachmentId(),
                        name: entry.name || 'Attachment',
                        type: entry.type || guessMimeTypeFromName(entry.name),
                        data: entry.data
                    }));
            });

            renderAllAttachmentLists();
        }

        // Income modal functions
        function openIncomeModal(target) {
            currentModalTarget = target;
            document.getElementById('modalTitle').textContent = 
                `Net Income Calculator - ${target === 'higher' ? 'Higher' : 'Lower'} Earner`;
            document.getElementById('incomeModal').style.display = 'block';
            
            // Clear all modal inputs
            clearModalInputs();
        }

        function closeIncomeModal() {
            document.getElementById('incomeModal').style.display = 'none';
        }

        function clearModalInputs() {
            for (let i = 1; i <= 15; i++) {
                document.getElementById(`income${i}`).value = '';
            }
            for (let i = 18; i <= 25; i++) {
                document.getElementById(`deduction${i}`).value = '';
            }
            document.getElementById('totalGrossIncome').value = '';
            document.getElementById('totalDeductions').value = '';
            document.getElementById('modalNetIncome').value = '';
        }

        function calculateModalNet() {
            let totalGross = 0;
            let totalDeductions = 0;

            // Calculate gross income
            for (let i = 1; i <= 15; i++) {
                const value = document.getElementById(`income${i}`).value;
                totalGross += parseCurrency(value);
            }

            // Calculate deductions
            for (let i = 18; i <= 25; i++) {
                const value = document.getElementById(`deduction${i}`).value;
                totalDeductions += parseCurrency(value);
            }

            // Update totals
            document.getElementById('totalGrossIncome').value = totalGross.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('totalDeductions').value = totalDeductions.toLocaleString('en-US', {minimumFractionDigits: 2});
            
            const netIncome = totalGross - totalDeductions;
            document.getElementById('modalNetIncome').value = netIncome.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        function applyModalIncome() {
            const netIncome = parseCurrency(document.getElementById('modalNetIncome').value);
            const targetInput = currentModalTarget === 'higher' ? 
                document.getElementById('higherIncome') : 
                document.getElementById('lowerIncome');
            
            targetInput.value = fmtInputMoney(netIncome);
            requiredFieldTouched[targetInput.id] = true;
            closeIncomeModal();
            refreshCalculationAvailability();
        }

        function isFieldFilled(fieldId) {
            const fieldEl = document.getElementById(fieldId);
            if (!fieldEl) {
                return false;
            }
            return String(fieldEl.value || '').trim() !== '';
        }

        function markAllRequiredFieldsTouched() {
            REQUIRED_FIELDS.forEach((field) => {
                requiredFieldTouched[field.id] = true;
            });
        }

        function getRequirementsState() {
            const issues = [];

            REQUIRED_FIELDS.forEach((field) => {
                if (!isFieldFilled(field.id)) {
                    issues.push(`${field.label} is required.`);
                    return;
                }

                if (!requiredFieldTouched[field.id]) {
                    issues.push(`${field.label} must be tabbed through.`);
                }
            });

            if (!issues.length) {
                const higherIncome = parseCurrency(document.getElementById('higherIncome').value);
                const lowerIncome = parseCurrency(document.getElementById('lowerIncome').value);
                const marriageDate = new Date(document.getElementById('marriageDate').value);
                const filingDate = new Date(document.getElementById('filingDate').value);

                if (higherIncome <= lowerIncome) {
                    issues.push('Higher earner income must be greater than lower earner income.');
                }

                if (filingDate <= marriageDate) {
                    issues.push('Date of Filing/Petition must be after Date of Marriage.');
                }
            }

            return {
                ready: issues.length === 0,
                issues: issues
            };
        }

        function updateRequirementsBar(state) {
            const bar = document.getElementById('requirementsBar');
            if (!bar) {
                return;
            }

            if (state.ready) {
                bar.textContent = 'All required terms complete';
                bar.classList.add('ready');
            } else {
                bar.textContent = 'Additional terms required';
                bar.classList.remove('ready');
            }
        }

        function showCalculatedSections(show) {
            const resultsEl = document.getElementById('results');
            const npvEl = document.getElementById('npvSection');

            if (show) {
                resultsEl.classList.add('show');
                npvEl.classList.remove('hidden');
            } else {
                resultsEl.classList.remove('show');
                npvEl.classList.add('hidden');
            }
        }

        function openRequirementsModalForState(state) {
            const summary = document.getElementById('requirementsSummary');
            const list = document.getElementById('requirementsList');
            list.innerHTML = '';

            if (state.ready) {
                summary.textContent = 'All required inputs are complete.';
            } else {
                summary.textContent = 'Complete the following items before results can be shown:';
                state.issues.forEach((issue) => {
                    const li = document.createElement('li');
                    li.textContent = issue;
                    list.appendChild(li);
                });
            }

            document.getElementById('requirementsModal').style.display = 'block';
        }

        function closeRequirementsModal() {
            document.getElementById('requirementsModal').style.display = 'none';
        }

        function handleRequirementsBarClick() {
            const state = getRequirementsState();
            if (!state.ready) {
                openRequirementsModalForState(state);
            }
        }

        function refreshCalculationAvailability(options) {
            const opts = options || {};
            const state = getRequirementsState();
            updateRequirementsBar(state);

            if (!state.ready) {
                showCalculatedSections(false);
                return false;
            }

            const didCalculate = calculateAlimony({ scrollIntoView: Boolean(opts.scrollIntoView) });
            showCalculatedSections(Boolean(didCalculate));
            return didCalculate;
        }

        function initializeRequiredFieldTracking() {
            REQUIRED_FIELDS.forEach((field) => {
                requiredFieldTouched[field.id] = false;
                const element = document.getElementById(field.id);
                if (!element) {
                    return;
                }

                element.addEventListener('input', function() {
                    refreshCalculationAvailability();
                });
                element.addEventListener('change', function() {
                    refreshCalculationAvailability();
                });
                element.addEventListener('blur', function() {
                    requiredFieldTouched[field.id] = true;
                    refreshCalculationAvailability();
                });
            });
        }

        // Main calculation functions
        document.getElementById('alimonyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const didCalculate = refreshCalculationAvailability({ scrollIntoView: true });
            if (!didCalculate) {
                openRequirementsModalForState(getRequirementsState());
            }
        });

        function calculateAlimony(options) {
            const opts = options || {};
            const higherIncome = parseCurrency(document.getElementById('higherIncome').value);
            const lowerIncome = parseCurrency(document.getElementById('lowerIncome').value);
            const marriageDate = new Date(document.getElementById('marriageDate').value);
            const filingDate = new Date(document.getElementById('filingDate').value);
            const reasonableNeed = parseCurrency(document.getElementById('reasonableNeed').value);

            if (!Number.isFinite(higherIncome) || !Number.isFinite(lowerIncome) || !Number.isFinite(reasonableNeed)) {
                return false;
            }

            if (higherIncome <= lowerIncome || filingDate <= marriageDate) {
                return false;
            }

            const yearsMarried = (filingDate - marriageDate) / (365.25 * 24 * 60 * 60 * 1000);

            let marriageType;
            let durationRatio;

            if (yearsMarried < 3) {
                marriageType = 'No Durational Alimony (Marriage < 3 years)';
                durationRatio = 0;
            } else if (yearsMarried < 10) {
                marriageType = 'Short Term Marriage';
                durationRatio = 0.5;
            } else if (yearsMarried < 20) {
                marriageType = 'Moderate Term Marriage';
                durationRatio = 0.6;
            } else {
                marriageType = 'Long Term Marriage';
                durationRatio = 0.75;
            }

            const incomeDifference = higherIncome - lowerIncome;
            const thirtyFivePercent = incomeDifference * 0.35;
            const maxAlimonyAmount = Math.min(reasonableNeed, thirtyFivePercent);
            const maxDurationYears = yearsMarried * durationRatio;
            const totalPayment = maxAlimonyAmount * 12 * maxDurationYears;

            // Update results
            document.getElementById('marriageType').textContent = marriageType;
            document.getElementById('yearsMarried').textContent = yearsMarried.toFixed(2) + ' years';
            document.getElementById('incomeDifference').textContent = fmtMoney(incomeDifference);
            document.getElementById('thirtyFivePercent').textContent = fmtMoney(thirtyFivePercent);
            document.getElementById('maxAlimonyAmount').textContent = fmtMoney(maxAlimonyAmount);
            document.getElementById('maxDuration').textContent = maxDurationYears.toFixed(2) + ' years';
            document.getElementById('totalPayment').textContent = fmtMoney(totalPayment);

            // Pre-populate NPV fields
            document.getElementById('npvAmount').value = fmtInputMoney(maxAlimonyAmount);
            document.getElementById('npvYears').value = maxDurationYears.toFixed(2);

            const warningDiv = document.getElementById('warningMessage');
            if (yearsMarried < 3) {
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = '<strong>Important:</strong> Durational alimony may not be awarded for marriages lasting less than 3 years under Florida Statute 61.08. Other types of alimony (bridge-the-gap or rehabilitative) may still be available.';
            } else {
                warningDiv.style.display = 'none';
            }

            calculateNPV();

            if (opts.scrollIntoView) {
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            }

            return true;
        }

        // --- NPV Calculation (Excel-compatible, always effective monthly + annuity-due) ---
        function calculateNPV() {
            const monthlyPayment = parseCurrency(document.getElementById('npvAmount').value);
            const years = parseFloat(document.getElementById('npvYears').value) || 0;
            const annualRate = parseFloat(document.getElementById('discountRate').value) / 100 || 0.05;

            if (monthlyPayment > 0 && years > 0) {
                // Calculate total payments over term
                const n = Math.round(years * 12); // total payments
                const totalPaid = monthlyPayment * n;
                document.getElementById('totalPaidOverTerm').textContent = fmtMoney(totalPaid);
                
                // Always use Excel's effective monthly rate and annuity-due
                const monthlyRate = Math.pow(1 + annualRate, 1/12) - 1;
                let pv = monthlyPayment * (1 - Math.pow(1 + monthlyRate, -n)) / monthlyRate;
                pv *= (1 + monthlyRate); // annuity-due adjustment
                document.getElementById('npvResult').textContent = fmtMoney(pv);
            } else {
                document.getElementById('totalPaidOverTerm').textContent = '$0.00';
                document.getElementById('npvResult').textContent = '$0.00';
            }
        }

        // Save/Load functionality
        async function saveData() {
            if (typeof JSZip === 'undefined') {
                alert('ZIP library is unavailable. Please refresh and try again.');
                return;
            }

            try {
                const exportData = exportStateWithAttachments();
                const zip = new JSZip();
                zip.file(ZIP_DATA_FILENAME, JSON.stringify(exportData.state, null, 2));

                exportData.attachments.forEach((attachment) => {
                    zip.file(`${ATTACHMENTS_FOLDER}${attachment.fileKey}`, attachment.base64, { base64: true });
                });

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const now = new Date();
                const pad2 = (value) => String(value).padStart(2, '0');
                const datePart = `${now.getFullYear()}-${pad2(now.getMonth() + 1)}-${pad2(now.getDate())}`;
                const timePart = `${pad2(now.getHours())}${pad2(now.getMinutes())}${pad2(now.getSeconds())}`;
                const higherEarnerNameRaw = document.getElementById('higherEarnerName').value.trim();
                const higherEarnerName = (higherEarnerNameRaw || 'UNNAMED')
                    .replace(/[<>:"/\\|?*\x00-\x1F]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim() || 'UNNAMED';
                const zipFileName = `${datePart}_${timePart}_${higherEarnerName}_ALIMONY CALC.zip`;
                const objectUrl = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = objectUrl;
                link.download = zipFileName;
                link.click();
                setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);
            } catch (error) {
                alert('Error saving ZIP file: ' + error.message);
            }
        }

        function loadData() {
            document.getElementById('fileInput').click();
        }

        async function loadLegacyJsonFile(file) {
            const text = await file.text();
            const data = JSON.parse(text);
            applyFormState(data || {});

            if (data && data.attachments) {
                importInlineAttachments(data.attachments);
            } else {
                clearAllAttachments();
            }

            markAllRequiredFieldsTouched();
            refreshCalculationAvailability();
        }

        async function loadZipFile(file) {
            if (typeof JSZip === 'undefined') {
                throw new Error('ZIP library is unavailable.');
            }

            const zip = await JSZip.loadAsync(file);
            const zipFiles = Object.keys(zip.files);
            const stateFileName = zip.file(ZIP_DATA_FILENAME)
                ? ZIP_DATA_FILENAME
                : zipFiles.find((name) => name.toLowerCase().endsWith('.json'));

            if (!stateFileName) {
                throw new Error('No JSON data file found in ZIP.');
            }

            const stateJson = await zip.file(stateFileName).async('string');
            const state = JSON.parse(stateJson);
            const attachmentLookup = {};

            const attachmentEntries = zipFiles.filter((name) => {
                const fileEntry = zip.files[name];
                return !fileEntry.dir && name.startsWith(ATTACHMENTS_FOLDER);
            });

            await Promise.all(attachmentEntries.map(async (name) => {
                const fileKey = name.slice(ATTACHMENTS_FOLDER.length);
                attachmentLookup[fileKey] = await zip.file(name).async('base64');
            }));

            importStateWithAttachments(state, attachmentLookup);
            markAllRequiredFieldsTouched();
            refreshCalculationAvailability();
        }

        async function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            try {
                if (file.name.toLowerCase().endsWith('.zip')) {
                    await loadZipFile(file);
                } else {
                    await loadLegacyJsonFile(file);
                }

                alert('Data loaded successfully!');
            } catch (error) {
                alert('Error loading file: ' + error.message);
            } finally {
                event.target.value = '';
            }
        }

        // Print to PDF functionality
        function printToPDF() {
            window.print();
        }

        // Initialize default dates and values
        window.addEventListener('load', function() {
            const today = new Date();
            const marriageDate = new Date(today.getFullYear() - 5, today.getMonth(), today.getDate());
            
            document.getElementById('filingDate').value = today.toISOString().split('T')[0];
            document.getElementById('marriageDate').value = marriageDate.toISOString().split('T')[0];
            document.getElementById('discountRate').value = '5.0';
            initializeMainCurrencyInputs();
            initializeRequiredFieldTracking();
            normalizeMainCurrencyInputValues();
            setupAttachmentDropZones();
            renderAllAttachmentLists();
            refreshCalculationAvailability();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const incomeModal = document.getElementById('incomeModal');
            const attachmentModal = document.getElementById('attachmentModal');
            const requirementsModal = document.getElementById('requirementsModal');
            if (event.target === incomeModal) {
                closeIncomeModal();
            }
            if (event.target === attachmentModal) {
                closeAttachmentModal();
            }
            if (event.target === requirementsModal) {
                closeRequirementsModal();
            }
        }
    </script>
</body>
</html>
